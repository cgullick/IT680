
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title>Open Source Jquery Calendar with Lasso on Knop</title>
        <link rel="stylesheet" type="text/css" href="reset.css">
        <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/start/jquery-ui.css">
        <link rel="stylesheet" type="text/css" href="jquery.weekcalendar.css">
        <link rel="stylesheet" type="text/css" href="weekcalendar.css">

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>
        <script type="text/javascript" src="jquery.weekcalendar.js"></script>

<script type="text/javascript">

$(document).ready(function() {

	var $calendar = $("#calendar");

	$calendar.weekCalendar({
		timeslotsPerHour : 4,
		allowCalEventOverlap : true,
		firstDayOfWeek : 1,
		timeFormat: "H:i",
		dateFormat: "Y-m-d",
		use24Hour : true,
		useHolidayCSS : true,
		useWeekNo: true, // Added by Jolle 2009-08-10
		buttonText : {
			today : "Today",
			lastWeek : "&nbsp;&lt;&nbsp;",
			nextWeek : "&nbsp;&gt;&nbsp;"
		},
		timeSeparator : " to ",
		businessHours :{start: 8, end: 18, limitDisplay: false },
		shortMonths : ["", "", "", "", "", "", "", "", "", "", "", ""],
		longMonths : ["", "", "", "", "", "", "", "", "", "", "", ""],
		shortDays : ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
		longDays : ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
		height : function($calendar) {
			return $(window).height() - $("h1").outerHeight();
		},
		eventRender : function(calEvent, $event) {
			if (calEvent.end.getTime() < new Date().getTime()) {
				$event.css("backgroundColor", "#aaa");
				$event.find(".wc-time").css({
					"backgroundColor" : "#999",
					"border" : "1px solid #888"
				});
			}
		},
		draggable : function(calEvent, $event) {
			return calEvent.readOnly != true;
		},
		resizable : function(calEvent, $event) {
			return calEvent.readOnly != true;
		},
		eventNew : function(calEvent, $event) {

			var $dialogContent = $("#event_edit_container");
			resetForm($dialogContent);
			var idField = $dialogContent.find("input[name='id']");
			$.get("ajax.lasso", {"actiontype": "getNewID"}, function(data){idField.val(data)});
			var startField = $dialogContent.find("select[name='start']").val(calEvent.start);
			var endField = $dialogContent.find("select[name='end']").val(calEvent.end);
			var summaryField = $dialogContent.find("input[name='summary']");
			var descriptionField = $dialogContent.find("textarea[name='description']");
			var locationField = $dialogContent.find("input[name='location']");


			$dialogContent.dialog({
				modal: true,
				title: "New Event",
				close: function() {
					$dialogContent.dialog("destroy");
					$dialogContent.hide();
					$('#calendar').weekCalendar("removeUnsavedEvents");
				},
				buttons: {
					"Save" : function(){
						$.ajax({
							type: "POST",
							url: "ajax.lasso?actionType=newevent",
							data: $("#event_edit_container form").serialize(),
							success: function(msg){
								msg.length > 0 ? alert(msg) :"";
								calEvent.id = idField.val();

								calEvent.start = new Date(startField.val());
								calEvent.end = new Date(endField.val());
								calEvent.summary = summaryField.val();
								calEvent.description = descriptionField.val();
								calEvent.location = locationField.val();

								$calendar.weekCalendar("removeUnsavedEvents");
								$calendar.weekCalendar("updateEvent", calEvent);
								$dialogContent.dialog("close");
							},
							error: function(e, r, s){
								var m = (r ? r : "");
								m += (s ? " " + s : "")
								alert(": " + m);
							}
						})
					},
					"Cancel" : function(){
						$dialogContent.dialog("close");
						$calendar.weekCalendar("removeUnsavedEvents");
					}
				}
			}).show();

            $dialogContent.find(".date_holder").text($calendar.weekCalendar("formatDate", calEvent.start));
            setupStartAndEndTimeFields(startField, endField, calEvent, $calendar.weekCalendar("getTimeslotTimes", calEvent.start));
            $(window).resize().resize(); //fixes a bug in modal overlay size ??


		},
		eventDrop : function(calEvent, $event) {
						$.ajax({
							type: "POST",
							url: "ajax.lasso?actionType=updateevent",
							data: {"eventAction": "dropped", "id": calEvent.id, "start": calEvent.start, "end": calEvent.end},
							success: function(msg){
								msg.length > 0 ? alert(msg) :"";
							},
							error: function(e, r, s){
								var m = (r ? r : "");
								m += (s ? " " + s : "")
								alert(": " + m);
							}
						})
					},
		eventResize : function(calEvent, $event) {
						$.ajax({
							type: "POST",
							url: "ajax.lasso?actionType=updateevent",
							data: {"eventAction": "resized", "id": calEvent.id, "start": calEvent.start, "end": calEvent.end},
							success: function(msg){
								msg.length > 0 ? alert(msg) :"";
							},
							error: function(e, r, s){
								var m = (r ? r : "");
								m += (s ? " " + s : "")
								alert(": " + m);
							}
						})
					},
		eventClick : function(calEvent, $event) {

			if(calEvent.readOnly) {
				return;
			}

			var $dialogContent = $("#event_edit_container");
			resetForm($dialogContent);
			var startField = $dialogContent.find("select[name='start']").val(calEvent.start);
			var endField = $dialogContent.find("select[name='end']").val(calEvent.end);
			var summaryField = $dialogContent.find("input[name='summary']").val(calEvent.summary);
			var descriptionField = $dialogContent.find("textarea[name='description']");
			descriptionField.val(calEvent.description);
			var locationField = $dialogContent.find("input[name='location']").val(calEvent.location);

			$dialogContent.dialog({
				modal: true,
				title: "Edit - " + calEvent.summary,
				close: function() {
					$dialogContent.dialog("destroy");
					$dialogContent.hide();
					$('#calendar').weekCalendar("removeUnsavedEvents");
				},
				buttons: {
					"Save" : function(){
						$.ajax({
							type: "POST",
							url: "ajax.lasso?actionType=updateevent",
							data: $("#event_edit_container form").serialize(),
							success: function(msg){
								msg.length > 0 ? alert(msg) :"";


								calEvent.start = new Date(startField.val());
								calEvent.end = new Date(endField.val());
								calEvent.summary = summaryField.val();
								calEvent.description = descriptionField.val();
								calEvent.location = locationField.val();

								$calendar.weekCalendar("removeUnsavedEvents");
								$calendar.weekCalendar("updateEvent", calEvent);
								$dialogContent.dialog("close");
							},
							error: function(e, r, s){
								var m = (r ? r : "");
								m += (s ? " " + s : "")
								alert(": " + m);
							}
						})
					},
					"Delete" : function(){
						if (confirm("Delete this record permanently? No undo possible!")){
							$.ajax({
								type: "POST",
								url: "ajax.lasso?actionType=deleteevent",
								data: {"id": calEvent.id},
								success: function(msg){
									msg.length > 0 ? alert(msg) :"";
									$calendar.weekCalendar("removeEvent", calEvent.id);
									$dialogContent.dialog("close");
								},
								error: function(e, r, s){
									var m = (r ? r : "");
									m += (s ? " " + s : "")
									alert(": " + m);
								}
							})
						}
					},
					"Cancel" : function(){
						$dialogContent.dialog("close");
					}
				}
			}).show();

			var idField = $dialogContent.find("input[name='id']").val(calEvent.id);
			var startField = $dialogContent.find("select[name='start']").val(calEvent.start);
			var endField = $dialogContent.find("select[name='end']").val(calEvent.end);
			$dialogContent.find(".date_holder").text($calendar.weekCalendar("formatDate", calEvent.start));
			setupStartAndEndTimeFields(startField, endField, calEvent, $calendar.weekCalendar("getTimeslotTimes", calEvent.start));
      		$(window).resize().resize(); //fixes a bug in modal overlay size ??

		},
		eventMouseover : function(calEvent, $event) {
		},
		eventMouseout : function(calEvent, $event) {
		},
		noEvents : function() {
		},
		data: function(start, end, callback) {
			$.getJSON("ajax.lasso", {
				actionType: "getcalendarevents",
				start: $calendar.weekCalendar("formatDate", start),
				end: $calendar.weekCalendar("formatDate", end)
			},  function(result) {
				callback(result);
			});
		},
		holidays: function(start, end, callback) {
			$.getJSON("ajax.lasso", {
				actionType: "getholidays",
				start: $calendar.weekCalendar("formatDate", start),
				end: $calendar.weekCalendar("formatDate", end),
				endtest: end
			},  function(result) {
				callback(result);
			});
		},
		holidayCont : [],
		holidayCheck : false
	});

	function resetForm($dialogContent) {
		 $dialogContent.find("input").val("");
		 $dialogContent.find("textarea").val("");
	}

	/*
	 * Sets up the start and end time fields in the calendar event
	 * form for editing based on the calendar event being edited
	 */
	function setupStartAndEndTimeFields($startTimeField, $endTimeField, calEvent, timeslotTimes) {

		for(var i=0; i<timeslotTimes.length; i++) {
			var startTime = timeslotTimes[i].start;
			var endTime = timeslotTimes[i].end;
			var startSelected = "";
			if(startTime.getTime() === calEvent.start.getTime()) {
				startSelected = "selected=\"selected\"";
			}
			var endSelected = "";
			if(endTime.getTime() === calEvent.end.getTime()) {
				endSelected = "selected=\"selected\"";
			}
			$startTimeField.append("<option value=\"" + startTime + "\" " + startSelected + ">" + timeslotTimes[i].startFormatted + "</option>");
			$endTimeField.append("<option value=\"" + endTime + "\" " + endSelected + ">" + timeslotTimes[i].endFormatted + "</option>");

		}
		$endTimeOptions = $endTimeField.find("option");
		$startTimeField.trigger("change");
	}

	var $endTimeField = $("select[name='end']");
	var $endTimeOptions = $endTimeField.find("option");

	//reduces the end time options to be only after the start time options.
	$("select[name='start']").change(function(){
		var startTime = $(this).find(":selected").val();
		var currentEndTime = $endTimeField.find("option:selected").val();
		$endTimeField.html(
			$endTimeOptions.filter(function(){
				return startTime < $(this).val();
			})
		);

		var endTimeSelected = false;
		$endTimeField.find("option").each(function() {
			if($(this).val() === currentEndTime) {
				$(this).attr("selected", "selected");
				endTimeSelected = true;
				return false;
			}
		});

		if(!endTimeSelected) {
			//automatically select an end date 2 slots away.
			$endTimeField.find("option:eq(1)").attr("selected", "selected");
		}

	});

	$("#exportchoice").change(function(){

		if($(this).val()) {
			window.location.href = "ajax.lasso?actionType=" + $(this).val() + "&start=" + dates.start + "&end=" + dates.end;
		}
	});

	var $about = $("#about");

	$("#about_button").click(function(){
		$about.dialog({
			title: "What's this all about?",
			width: 600,
			close: function() {
				$about.dialog("destroy");
				$about.hide();
			},
			buttons: {
				Close : function(){
					$about.dialog("close");
				}
			}
		}).show();
	});

	// Deal with imports of Icalendar files
	var $importical = $("#importical");

	$("#import_button").click(function(){

		window.open("ajax.lasso?actionType=initimport&checkValue=", "Import","status=no,addressbar=no,scrollbars=no,resizable=yes,width=333,height=100");

	});

});

function wc_refresh() {
	$("#calendar").weekCalendar("refresh");
}

</script>
</head>
<body>
        <h1>Open Source Jquery Calendar with Lasso on Knop</h1>
        <div id="about_button_container">
        		<select id="exportchoice" name="exportchoice">
				<option label="Choose export" value="" selected="selected">Choose export</option>
				<option label="This week as iCalendar object" value="exporticalweek">This week as iCalendar object</option>
				<option label="Entire calendar as iCalendar object" value="exporticalall">Entire calendar as iCalendar object</option>
			</select> - - 
                <button type="button" id="import_button">Import</button> - - 
                <button type="button" id="about_button">About</button>
        </div>
        <div id='calendar'></div>
        <div id="event_edit_container">
                <form>
                        <input name="id" type="hidden">
                        <ul>
                                <li>
                                        <span>Date: </span><span class="date_holder"></span>
                                </li>
                                <li>
                                        <label for="wc-cal_summary">Vad: </label><input id="wc-cal_summary" type="text" name="summary">
                                </li>
                                <li>
                                        <label for="wc-cal_location">Where: </label><input id="wc-cal_location" type="text" name="location">
                                </li>
                                <li>
                                        <label for="wc-cal_start">Start Time: </label><select id ="wc-cal_start" name="start"><option value="">Select Start Time</option></select>
                                </li>
                                <li>
                                        <label for="wc-cal_end">End Time: </label><select id="wc-cal_end" name="end"><option value="">Select End Time</option></select>
                                </li>
                                <li>
                                        <label for="wc-cal_description">Note: </label><textarea id="wc-cal_description" name="description"></textarea>
                                </li>
                        </ul>
                </form>
        </div>
        <div id="about">                <p>
                        This calendar is based on the Jquery plugin Weekcalendar by Rob Monie with some additional Javascript by Jolle Carlestam. The server side is all Lasso on Knop written by Jolle Carlestam. Source code can be downloaded from <a href="http://code.google.com/p/knop/" target="_blank">code.google.com/p/knop/</a>.
                </p>
                <p>
                        ***Note: This demo is still work in progress. Stability can go up or down.
                </p>
                <h2>Demonstrated Features</h2>
                <p>
                        This calendar implementation demonstrates the following features:
                </p>
                <ul class="formatted">
                        <li>Adding, updating and deleting of calendar events using jquery-ui dialog. Events are retrieved from and stored in a Mysql database using ajax calls. Database actions are provided with the help of Knop</li>
                        <li>Dragging and resizing of calendar events</li>
                        <li>Restricted timeslot rendering based on business hours, option that can be turned on in the config</li>
                        <li>Week starts on Monday. Other start days available thru config</li>
                        <li>Allowing event overlap with staggered rendering of overlapping events</li>
                        <li>Calendar can be localised thru config. Available languages: English, Swedish, Danish. Additional languages are easily added. Localisation is provided with the help of Knop</li>
                        <li>Events can be exported as iCalendar files. Either events for the shown week or for the entire calendar</li>
                        <li>Events can be imported into the calendar in the form of Icalendar files (.ics). Either single events or several within the same VCALENDAR container
                        <li>CSS rules are isolated enabling integration into a site without css rules bleeding into or from the calendar
                </ul>

        </div>

</body>
</html>